<template>
    <div>
        <el-breadcrumb separator="/">
            <el-breadcrumb-item :to="{ path: '/discover/official' }" >官方动态</el-breadcrumb-item>
            <el-breadcrumb-item class="now_page">发现审核</el-breadcrumb-item>
        </el-breadcrumb>
        <div class="search">
            <el-select v-model="search.status" placeholder="选择列表状态" size="mini" style="float:left;">
                <el-option label="推荐" value="0"></el-option>
                <el-option label="关注" value="1"></el-option>
                <el-option label="最新" value="2"></el-option>
            </el-select>
            <el-select v-model="search.type" placeholder="选择媒体类型" size="mini" style="float:left;margin:0 10px;" clearable>
                <el-option label="所有媒体类" value="0"></el-option>
                <el-option label="图片" value="1"></el-option>
                <el-option label="视频" value="2"></el-option>
                <el-option label="纯文本" value="3"></el-option>
                <el-option label="语音" value="4"></el-option>
            </el-select>
            <el-button type="primary" plain size="mini" style="float:left" @click="showList()">查询</el-button>
        </div>
        <el-table :data="tableData" style="width: 100%;margin-top:15px;" border size="mini" v-loading="loading">
            <!-- <el-table-column prop="id" label="序号" align="center"></el-table-column> -->
            <el-table-column label="用户名称" align="center">
                <template slot-scope="props">
                    <el-button type="text" @click="$router.push({name:'userPersonalFile'})" >{{ props.row.userName }}</el-button>
                </template>
            </el-table-column>
             <el-table-column label="发表时间" align="center" width="90">
              <template slot-scope="props">
                {{ new Date(props.row.createTime) | moment('YYYY-MM-DD HH:ss:mm') }}
              </template>
            </el-table-column>
            <el-table-column label="文字内容" align="center" width="120">
              <template slot-scope="props">
                <el-popover
                  placement="right-start"
                  title="文字内容"
                  width="300"
                  trigger="hover"
                  :content="props.row.content">
                  <el-button type="text" slot="reference" class="contentBtn">{{props.row.content}}</el-button>
                </el-popover>
                <!-- <el-tooltip :content="props.row.content" placement="top">
                  <el-button type="text">{{ props.row.content }}</el-button>
                </el-tooltip> -->
                <!-- <p>{{ props.row.content }}</p> -->
              </template>
            </el-table-column>
            <el-table-column prop="coverType" label="媒体内容" align="center" width="230">
              <template slot-scope="props">
                  <div v-if="props.row.coverType == 0">
                    <img :src="$oss.url + ele" alt="" v-for="(ele,index) in props.row.coverResources" :key="index" width="100" style="margin:0 3px 3px 0  ">
                  </div>
                  <div v-if="props.row.coverType == 1">
                    <video :src="$oss.url + ele" v-for="(ele,index) in props.row.coverResources" :key="index" width="200" controls="controls"></video>
                  </div>
                  <div v-if="props.row.coverType == 2">
                    <audioPlayer 
                    :url="ele" 
                    :second="props.row.second" 
                    v-for="(ele,index) in props.row.coverResources" 
                    :key="index" 
                    style="margin-left:50px;"/>
                  </div>
              </template>
            </el-table-column>
            <el-table-column prop="likeNum" label="点赞数" align="center" sortable></el-table-column>
            <el-table-column prop="collectNum" label="收藏数" align="center" sortable></el-table-column>
            <el-table-column prop="transpondNum" label="转发数" align="center" sortable></el-table-column>
            <el-table-column prop="pageViewNum" label="浏览量" align="center" sortable></el-table-column>
            <el-table-column  label="位置" align="center">
              <template slot-scope="props">
                {{ props.row.location == '' ? '未定位' : props.row.location}}
              </template>
            </el-table-column>
            <el-table-column prop="name" label="选择标签" align="center"></el-table-column>
            <el-table-column label="文章类型" align="center">
              <template slot-scope="props">
                {{ props.row.type == 0 ? '普通文章' : props.row.type == 1 ? '官方文章' : '-'}}
              </template>
            </el-table-column>
           
            <el-table-column label="审核状态" align="center" width="90">
              <template slot-scope="props">
                {{ props.row.state == 0 ? '待审核' : props.row.state == 1 ? '审核通过' : '审核不通过' }}
              </template>
            </el-table-column>
            <el-table-column label="状态" align="center">
              <template slot-scope="props">
                <el-button type="primary"  size="mini" plain class="caozuoBtn zdBtn"  @click="shenhePass(props.row,1)">审核通过</el-button>
                <el-button type="danger"  size="mini" plain class="caozuoBtn"   @click="shenhePass(props.row,0)">审核不通过</el-button>
              </template>
            </el-table-column>
            <el-table-column prop="address" label="操作" align="center">
                 <template slot-scope="props">
                    <el-button type="primary"  size="mini" plain class="caozuoBtn" @click="dialogVisible=true;selectPinglun(props.row.comments,props.row.id)">查看评论</el-button>
                    <el-button type="primary"  size="mini" plain class="caozuoBtn zdBtn" v-if="props.row.hot==0" @click="tuijianPost(props.row,1)">置顶推荐</el-button>
                <el-button type="primary"  size="mini" plain class="caozuoBtn" v-else @click="tuijianPost(props.row,0)">不推荐</el-button>
                </template>
            </el-table-column>
        </el-table>
        <div class="block" style="float: right;margin-top: 15px">
            <el-pagination layout="total,prev, pager, next" :page-size="size" background :page-count="pages" :total="total" @current-change="handleCurrentChange"></el-pagination>
        </div>
        <el-dialog title="评论" :visible.sync="dialogVisible" width="30%">
          <div class="pl_Box">
            <div v-for="(item,index) in this.pinglunData" :key="index" class="pinglun">
              <img :src="$oss.url+item.userHead" alt="" width="50" height="50">
              <span>{{ item.userName }}</span>
              <span style="float:right">{{ new Date(item.createTime) | moment('YYYY-MM-DD HH:mm:ss') }}</span>
              <div>{{ item.content }}
                <p>
                  <span>
                    <span style="color:blue">{{ item.replyUser.userName }}</span>
                    回复<span style="color:blue">{{ item.userName }}</span>：
                    <span>{{ item.replyUser.content }}</span>
                  </span>
                </p>
              </div>
            </div>
            <div class="block" style="float: right;margin-top: 15px">
                <el-pagination layout="total,prev, pager, next" :page-size="pl_size" background :page-count="pl_pages" :total="pl_total" @current-change="pl_handleCurrentChange"></el-pagination>
            </div>
          </div>
          
        </el-dialog>
    </div>
</template>

<script>
import audioPlayer from '../../components/audioPlayer'
export default {
  name: "audit", //发现审核
  components:{
    audioPlayer
  },
  data() {
    return {
      dialogVisible:false,  //评论
      loading:false,  //加载
      search: {
        status: "", //列表状态
        type: "" //媒体类型
      },
      tableData: [], //列表
      page:1,   //当前页
      total:null,   //条目总数
      size:null,    //每页数
      pages:null,    //页数
      pl_page:1,
      pl_total:null,   //条目总数
      pl_size:null,    //每页数
      pl_pages:null,    //页数
      pinglunData:[],
    };
  },
  created() {
    this.showList();
  },
  methods: {
    handleCurrentChange(val){
      this.page = val;
      this.showList(val);
    },
    // 列表展示，搜索
    showList(page) {
      // const page = this.page
      const pl_page = this.pl_page 
      this.loading = true;
      this.$api.find.find_audit(data=>{
        this.loading = false;
        this.tableData = data.data;
        // 遍历给评论页赋值
        this.tableData.map(item=>{
          if(this.id === item.id){  //找到所选评论的数据
            this.pinglunData = item.comments.commentData
          }
        })
        this.total = data.pageNum.total
        this.size = data.pageNum.pageSize
        this.pages = data.pageNum.pages
      },{
        pageNum:page,
        commentPageNum:pl_page,
      })
      
    },
    shenhePass(row,val){
      if(val==0){
        this.$confirm("确定此条动态不被通过吗？", "提示", {
          confirmButtonText: "狠心pass",
          cancelButtonText: "取消",
          type: "warning"
        })
          .then(() => {
              this.$api.find.shenhe_nopass(()=>{
                this.$notify({
                  type: "success",
                  message: "此条动态不被通过!",
                  title:'成功'
                });
                this.showList(this.page)
              },{
                id:row.id,
                userId:row.userId,
              })
          })
          .catch(() => {
            this.$message({
              type: "info",
              message: "已取消"
            });
          });
      }else if(val==1){
        this.$confirm("确定此条动态被审核通过吗？", "提示", {
          confirmButtonText: "确认通过",
          cancelButtonText: "取消",
          type: "warning"
        })
        .then(() => {
          this.$api.find.shenhe_pass(()=>{
            this.$notify({
              type: "success",
              message: "此条动态被审核通过!",
              title:'成功'
            });
              this.showList(this.page)
          },{
            id:row.id,
            userId:row.userId,
          })
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消"
          });
        }); 
      }     
    },
    tuijianPost(row,status){
        this.$confirm("确定要修改此推荐的置顶状态吗？", "提示", {
          confirmButtonText: "确认修改",
          cancelButtonText: "取消",
          type: "warning"
        })
        .then(() => {
          this.$api.find.shenhe_tuijian(()=>{
            this.$notify({
              type: "success",
              message: "已修改置顶状态!",
              title:'成功'
            });
              this.showList(this.page)
          },{
            id:row.id,
            hot:status,
          })
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "已取消"
          });
        }); 
    },
    // 评论分页
    pl_handleCurrentChange(val){
      this.pl_page = val;
      this.showList()
    },
    // 点击评论赋值
    selectPinglun(comments,id){
      this.id = id
      this.pinglunData = comments.commentData
      this.pl_total = comments.commentPageNum.total
      this.pl_size = comments.commentPageNum.pageSize
      this.pl_pages = comments.commentPageNum.pages
    }
  }
};
</script>

<style scoped lang="less">
.search {
  margin-top: 15px;
  overflow: hidden;
  width: 500px;
}
.caozuoBtn {
  display: block;
  margin: 5px auto;
  width: 90px;
}
.pl_Box{
  overflow: hidden;
  .pinglun{
    width: 100%;
    padding: 5px;
    border:1px solid #ccc;
    margin-top: 5px;
    div{
      background: #eee;
      padding-left: 15px;
    }
  }
}
.contentBtn{
  width: 100px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow:ellipsis;
  color: #606266;
}
</style>
